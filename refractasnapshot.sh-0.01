#!/usr/bin/env bash
# refractasnapshot.sh-0.01
# based on refractasnapshot-8.0.4
# fsmithred@gmail.com (May 1, 2011)


echo "Starting..."
cd /tmp
rm -rf work
mkdir work
cd /tmp/work
mkdir /tmp/work/iso

echo "Copying..."
rsync -a /usr/local/lib/refractasnapshot/iso/ /tmp/work/iso/
cp /vmlinuz /tmp/work/iso/live/
cp /initrd.img /tmp/work/iso/live/
mkdir myfs
rsync -a / myfs/ --exclude-from=/usr/local/lib/refractasnapshot/exclude.list

echo "Squashing..."
mksquashfs myfs/ iso/live/filesystem.squashfs
rm -rf myfs

echo "Creating..."
mkdir /home/snapshot
chmod 777 /home/snapshot
mv /home/snapshot/snapshot.iso /home/snapshot/old-snapshot.iso
genisoimage -r -J -l -D -o /home/snapshot/snapshot.iso -cache-inodes -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table iso/

echo "Cleaning..."
cd /
rm -rf /tmp/work

echo "All finished!"

exit 0
